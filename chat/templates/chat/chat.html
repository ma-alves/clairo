{% extends "base.html" %}

{% block content %}
<wrapper class="block max-w-2xl mx-auto my-10 px-6">
    <!-- Container principal do chat -->
    <div id="chat-window" class="h-[45rem] flex flex-col bg-gray-800 rounded-2xl shadow-2xl relative p-1 mb-4">
        <!-- Cabeçalho do chat -->
        <div class="flex justify-center text-emerald-400 bg-gray-800 p-2 sticky top-0 z-10 rounded-t-2xl">
            <div id="online-icon" class="gray-dot absolute top-2 left-2"></div>
            <a href="{% url 'profile' other_user.pk %}">
                <div class="flex items-center gap-2 p-4">
                    <img class="w-10 h-10 rounded-full object-cover bg-gray-600" src="#"
                        alt="{{ other_user.username }}" />
                    <div>
                        <span class="font-bold text-white">{{ other_user.username }}</span>
                        <span class="text-sm font-light text-gray-400 block">@{{ other_user.username }}</span>
                    </div>
                </div>
            </a>
        </div>

        <!-- Área de mensagens -->
        <div id='chat_container' class="overflow-y-auto grow">
            <ul id='chat_messages' class="flex flex-col justify-end gap-2 p-4">
                {% for message in chat_messages reversed %}
                    {% if message.author == user %}
                    <li>
                        <div class="flex justify-end">
                            <div class="bg-green-200 rounded-l-lg rounded-lg p-2 max-w-[75%]">
                                <span>{{ message.body }}</span>
                            </div>
                        </div>
                        <!-- <span class="text-xs text-gray-400 mt-1">{{ message.created_at|time:"H:i" }}</span> -->
                    </li>
                    {% else %}
                    <li>
                        <div class="flex justify-start">
                            <div class="bg-white p-2 max-w-[75%] rounded-r-lg rounded-lg">
                                <span>{{ message.body }}</span>
                            </div>
                        </div>
                        <!-- <span class="text-xs text-gray-400 mt-1">{{ message.created_at|time:"H:i" }}</span> -->
                    </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>

        <div class="sticky bottom-0 bg-gray-800 p-4 rounded-b-2xl">
            <div class="flex gap-2">
                <textarea id="chat-message-input"
                    class="flex-1 px-4 py-2 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400 resize-none"
                    placeholder="Mensagem..." rows="1"></textarea>
                <button id="chat-message-submit"
                    class="px-6 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-colors self-end">
                    Enviar
                </button>
            </div>
        </div>
    </div>

    <div>
        {% for chat in request.user.chats.all %}
            {% for user in chat.users.all %}
                {% if user != request.user %}
                <div>
                    <a href="{% url 'chat' chat.chat_uuid %}">{{ user.username }}</a>
                </div>
                {% endif %}
            {% endfor %}
        {% endfor %}
    </div>

    {{ chat_uuid|json_script:"chat_uuid" }}

</wrapper>
{% endblock %}

{% block scripts %}
<script id="current-id" type="application/json">{{ user.id|escapejs }}</script>
<script>
    const roomName = JSON.parse(document.getElementById('chat_uuid').textContent);
    const currentUser = JSON.parse(document.getElementById('current-id').textContent);

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/chat/'
        + roomName
        + '/'
    );

    chatSocket.onmessage = function (e) {
        try {
            const data = JSON.parse(e.data);
            if (data.message) {
                // Adicionar mensagem à área de visualização
                const chatMessages = document.querySelector('#chat_messages');
                const messageElement = document.createElement('li');

                if (data.user === currentUser) {
                    messageElement.className = 'flex justify-end';
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'bg-green-200 rounded-l-lg rounded-lg p-2 max-w-[75%]';
                    messageDiv.textContent = data.message;
                    messageElement.appendChild(messageDiv);
                } else {
                    messageElement.innerHTML = `
                        <div class="flex justify-start">
                            <div class="bg-white p-2 max-w-[75%] rounded-r-lg rounded-lg">
                                <span>${data.message}</span>
                            </div>
                        </div>`;
                }
                chatMessages.appendChild(messageElement);

                // Scroll automático
                const chatContainer = document.querySelector('#chat_container');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        } catch (error) {
            console.error('Erro ao processar mensagem:', error);
        }
    };

    chatSocket.onclose = function (e) {
        console.error('Chat socket fechou inesperadamente.');
    };

    document.querySelector('#chat-message-input').focus();

    document.querySelector('#chat-message-input').onkeyup = function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function (e) {
        const messageInput = document.querySelector('#chat-message-input');
        const chat_message = messageInput.value.trim();

        if (chat_message) {
            chatSocket.send(JSON.stringify({
                'message': chat_message,
            }));
            messageInput.value = '';
        }
    };

    function scrollToBottom(time = 0) {
        setTimeout(function () {
            const container = document.getElementById('chat_container');
            container.scrollTop = container.scrollHeight;
        }, time);
    }
    scrollToBottom()
</script>
{% endblock%}