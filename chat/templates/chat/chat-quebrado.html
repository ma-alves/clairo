{% extends "base.html" %}

{% block content %}
<wrapper class="block max-w-2xl mx-auto my-10 px-6">
    <div class="flex justify-between">
        <h2>{{ other_user }}</h2>
        <div id="chat-window" class="h-[45rem] flex flex-col bg-gray-800 rounded-2xl shadow-2xl relative p-1">
            <div class="flex justify-center text-emerald-400 bg-gray-800 p-2 sticky top-0 z-10">
                <div id="online-icon" class="gray-dot absolute top-2 left-2"></div>
                <a href="#">
                    <div class="flex items-center gap-2 p-4 sticky top-0 z-10">
                        <img class="w-10 h-10 rounded-full object-cover" src="#" />
                        <div>
                            <span class="font-bold text-white">{{ other_user.username }}</span>
                            <span class="text-sm font-light text-gray-400">@{{ other_user.username }}</span>
                        </div>
                    </div>
                </a>
                <ul id="groupchat-members" class="flex gap-4">
                    {% for user in chat.users.all %}
                    <li>
                        <a href="{% url 'profile' user.id %}"
                            class="flex flex-col text-gray-400 items-center justify-center w-20 gap-2">
                            <!-- <img src="{{ member.profile.avatar }}" class="w-14 h-14 rounded-full object-cover" /> -->
                            {{ user.username|slice:":10" }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div id='chat_container' class="overflow-y-auto grow">
                <ul id='chat_messages' class="flex flex-col justify-end gap-2 p-4">
                    {% for message in chat_messages reversed %}
                    {% include 'chat/chat_message.html' %}
                    {% endfor %}
                </ul>
            </div>
        </div>
        <textarea id="chat-log" cols="100" rows="20"></textarea><br>
        <input id="chat-message-input" type="text" size="100"><br>
        <input id="chat-message-submit" type="button" value="Send">
    </div>
    {{ chat_uuid|json_script:"chat_uuid" }}
    <script>
        const roomName = JSON.parse(document.getElementById('chat_uuid').textContent);

        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + roomName
            + '/'
        );

        chatSocket.onmessage = function (e) {
            try {
                const data = JSON.parse(e.data);
                if (data.message) {
                    const chatLog = document.querySelector('#chat-log');
                    chatLog.value += data.message + '\n';
                    chatLog.scrollTop = chatLog.scrollHeight;
                }
            } catch (error) {
                console.error('Erro ao processar mensagem:', error);
            }
        };

        chatSocket.onclose = function (e) {
            console.error('Chat socket fechou inesperadamente.');
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function (e) {
            if (e.key === 'Enter') {
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function (e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        };
    </script>
</wrapper>
{% endblock %}